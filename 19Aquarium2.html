<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Aquarium</title>
    <script src="jquery-3.3.1.min.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Press+Start+2P' rel='stylesheet' type='text/css'>
</head>
<script>
/*
*TODO:
*Auswahl Anzahl Spezies (Auswahl anzahl fische?)
*Highscore+Namenseingabe(gespeichert am Server, sortierbar(anzahl Spezies,Zeit))
*Fressen und Duplikation DONE
*Anzeige wieviele Arten ausgestorben( Ende bei mehr als x%)
*Hintergrundfarbe Fische DONE
* zusätzliche Sprites (10)
* wenn möglich Hintergrundsprites
*Canvas Responsive (Frage anzahl Max Fische)//geht nicht
*
*/


    /*vars **********************************************************************/
    $(document).ready(function(){
        // $('#canvas').outerHeight($(window).height());
        // $('#canvas').outerWidth($(window).width());
         // var c = $( '<canvas>', { width:$(window).width()-100, height:$(window).height()-100,id:"canvas" } )
         //  .prependTo( 'body' );

        var canvas = document.getElementById('canvas');
         var canvasWidth = canvas.width;
         var canvasHeight = canvas.height;

         // var canvasHeight=1000;
         // var canvasWidth= 1800;
        var canvas = document.getElementsByTagName('canvas')[0];
        var ctx = canvas.getContext('2d');
    /*Daten*********************************************************************/
    var image1 = new Image();
    image1.src ="fish.png";
    var image2 = new Image();
    image2.src ="seaweed.png";
    var image3 = new Image();
    image3.src ="treasures.png";
    var seaweedSprites=[{image:image2,posx:19,posy:41,width:188,height:299}];
    var fishSprites=[
        {image:image1,posx:71,posy:31,width:62,heigth:61},
        {image:image1,posx:215,posy:39,width:76,heigth:51},
        {image:image1,posx:349,posy:42,width:84,heigth:56},
        {image:image1,posx:480,posy:42,width:121,heigth:60},
        {image:image1,posx:68,posy:204,width:78,heigth:54},
        {image:image1,posx:461,posy:204,width:44,heigth:66},
        {image:image1,posx:588,posy:212,width:126,heigth:70},
        {image:image1,posx:85,posy:380,width:67,heigth:63},
        {image:image1,posx:373,posy:436,width:77,heigth:41},
        {image:image1,posx:538,posy:388,width:53,heigth:75}

    ];

    var listOfSpecies =[{
        animal:"BlackWhite",amount:5,eats:["RedBlack"]},
        {animal:"RedBlack",amount:5,eats:["Red"]},
        {animal:"Red",amount:5,eats:["BlueLong"]},
        {animal:"BlueLong",amount:5,eats:["Yellow"]},
        {animal:"Yellow",amount:5,eats:["Shrimp"]},
        {animal:"Shrimp",amount:5,eats:["Crab"]},
        {animal:"Crab",amount:5,eats:["BlueSquare"]},
        {animal:"BlueSquare",amount:5,eats:["Nemo"]},
        {animal:"Nemo",amount:5,eats:["Seepferd"]},
        {animal:"Seepferd",amount:5,eats:["BlackWhite"]}

    ];
    var arrayOfSpecies = [];

    function createSpecies(species,quantity,eats,fishSprite){
        var temparr = [];
        var x = 0;
        var y = 0;
        var cnt =0;
            for(let i =0; i<quantity;i++){
                x =createX();
                y= createY();
                while(initial_collision(x,y,fishSprite.width,fishSprite.heigth,arrayOfSpecies,temparr)){
                    y= createY();
                    x=createX();
                }
                temparr.push({
                    species:species,
                    x:x,
                    y:y,
                    vx:((Math.random()*2)),
                    vy:((Math.random()*2)),
                    height:fishSprite.heigth,
                    width:fishSprite.width,
                    posy:fishSprite.posy,
                    posx:fishSprite.posx,
                    eats:eats
                    })

            }

        arrayOfSpecies.push(temparr);
    }


    function createX(){
        var x;
        x = Math.random()*canvasWidth -80;
        if(x <20){
            x=100;
        }
        return x;
    }

    function createY() {
        var y;
        y = Math.random()*canvasHeight -80;
        if(y <20){
            y=100;
        }
        return y;
    }
    function initial_collision(x,y,width,height,arraytocheck,temparr){
        //arrayOfSpeciescheck
        for(let k =0;k< arraytocheck.length;k++){
            for(let l=0;l<arraytocheck[k].length;l++){
                var o1 = arraytocheck[k][l];
                var no_collision = (
                    o1.x >= x + width ||
                    o1.x + o1.width <= x ||
                    o1.y >= y + height ||
                    o1.y + o1.height < y
                );
                if(no_collision == false){
                    return true;
                }//end of if
            }//end of l (2nd)
        }//end of k (first)

        //temparrcheck
        for(let i =0;i< temparr.length;i++){
                var o2 = temparr[i];
                var no_collision = (
                    o2.x >= x + width ||
                    o2.x + o2.width <= x ||
                    o2.y >= y + height ||
                    o2.y + o2.height < y
                );
                if(no_collision == false){
                    return true;
                }//end of if
        }//end of i (first)
        return false;//return wenn keine collision
    }//initial_collision end

    /*Execute*********************************************************************/
    for(let i = 0; i<listOfSpecies.length; i++){
        //console.log(listOfSpecies[i].animal,listOfSpecies[i].amount,listOfSpecies[i].eats,fishSprites[i]);
        createSpecies(listOfSpecies[i].animal,listOfSpecies[i].amount,listOfSpecies[i].eats,fishSprites[i]);
    }
    /*Draw*********************************************************************/
    var cancelMe = "";
    var highscore =0;
    var currentTime = new Date();
    var milliseconds = 1000;
    var time ;
    function increaseHighscore(){
        time = new Date();
        if(time-currentTime>milliseconds){
            highscore++;
            currentTime= new Date();
            $('#highscore').html('Score: '+highscore);
        }
    }

    function loop(){
        draw();
        increaseHighscore();
    }
    function draw(){
        ctx.clearRect(0,0,canvasWidth,canvasHeight);
        ctx.beginPath();
        ctx.drawImage(image2,seaweedSprites[0].posx,seaweedSprites[0].posy,seaweedSprites[0].width,seaweedSprites[0].height,500,500,seaweedSprites[0].width,seaweedSprites[0].height);
        for(let i = arrayOfSpecies.length -1;i>=0;i--){
            //console.log(arrayOfSpecies);
            for(var j =arrayOfSpecies[i].length-1; j>=0;j--){
                ctx.drawImage(image1,arrayOfSpecies[i][j].posx,arrayOfSpecies[i][j].posy,arrayOfSpecies[i][j].width,arrayOfSpecies[i][j].height,arrayOfSpecies[i][j].x,arrayOfSpecies[i][j].y,arrayOfSpecies[i][j].width,arrayOfSpecies[i][j].height );

                if((arrayOfSpecies[i][j].x + arrayOfSpecies[i][j].vx + arrayOfSpecies[i][j].width > canvasWidth) || (arrayOfSpecies[i][j].x + arrayOfSpecies[i][j].vx < 0)){
                    arrayOfSpecies[i][j].vx = - arrayOfSpecies[i][j].vx;
                }
                if((arrayOfSpecies[i][j].y + arrayOfSpecies[i][j].vy +arrayOfSpecies[i][j].height > canvasHeight) || (arrayOfSpecies[i][j].y+ arrayOfSpecies[i][j].vy < 0)){
                    arrayOfSpecies[i][j].vy = - arrayOfSpecies[i][j].vy;
                }
               arrayOfSpecies[i][j].x +=arrayOfSpecies[i][j].vx;
               arrayOfSpecies[i][j].y +=arrayOfSpecies[i][j].vy;
                //collision

            }//end of inner for loop
        }//end of outer for loop

        for(let k =0;k< arrayOfSpecies.length;k++){
            for(let l=0;l<arrayOfSpecies[k].length;l++){

                checkCollision(arrayOfSpecies[k][l], k, l);


            }//end of k loop(inner)
        }//end of l loop(outer)

        cancelMe = requestAnimationFrame(loop);
    }//end of draw

function checkCollision(o1, k, l) {
    var o2;
    for(var hh = 0; hh < arrayOfSpecies.length;hh++){
        for(let mm =0;mm < arrayOfSpecies[hh].length;mm++){


            if(hh == k && mm == l)
                continue;

            o2 = arrayOfSpecies[hh][mm];

        var no_collision = (
            o1.x > o2.x + o2.width ||
            o1.x + o1.width < o2.x ||
            o1.y > o2.y + o2.height ||
            o1.y + o1.height < o2.y
        );

        if(no_collision == false){
                // ctx.fillText(o1.x,arrayOfSpecies[k][l].x,arrayOfSpecies[k][l].y);
                // ctx.fillText(o2.x,arrayOfSpecies[k][l].x,arrayOfSpecies[k][l].y+50);
                 // o1.vy= -o1.vy;
                 o1.vx= -o1.vx;



                if(o2.species!=o1.species){
                    // console.log("collision:"+o2.species +" "+o1.species);
                    //check if eats-> params: species1,species2
                        for(let h =0;h<o2.eats.length;h++){

                             if(o2.eats[h]==o1.species ){
                                 //delete o1..(splice), create o2 at same coords
                                 //find index of o1 to delete
                                var target = o1;
                                var targetKeys =Object.keys(target);
                                var index = arrayOfSpecies[k].findIndex(function(entry){
                                     var keys = Object.keys(entry);
                                     return keys.length==targetKeys.length && keys.every(function(key){
                                         return target.hasOwnProperty(key)&&entry[key] === target[key];
                                     });
                                 });
                                 // console.log("index: "+index);
                                if(index>-1){
                                    //console.log("o2eatso1");

                                    //löschen wenn eats
                                    arrayOfSpecies[k].splice(index,1);
                                    var x = createX();
                                    // o2.x+o2.width+10;
                                    var y = createY();
                                     // o2.y+o2.height+10;
                                    while(initial_collision2(x,y,o2.width,o2.height,arrayOfSpecies)){
                                        x =createX();
                                        y =createY();
                                    }

                                   arrayOfSpecies[k].push({
                                        species:o2.species,
                                        x:x,
                                        y:y,
                                        vx:o2.vx,
                                        vy:o2.vy,
                                        width:o2.width,
                                        height:o2.height,
                                        posy:o2.posy,
                                        posx:o2.posx,
                                        eats:o2.eats
                                    });
                            //         // console.log(arrayOfSpecies[k]);
                                 }//end of splice
                            //     //console.log(o2.x);
                             }//end of if(eats)
                        }//end of for h
                    }//end of if Species=species

                return;
                }//end of if

        }//end of mm loop
    }//end of hh loop
}//end of checkCollision

function initial_collision2(x,y,width,height,arraytocheck){

    for(let i=0; i<arraytocheck.length;i++){
        console.log(i);
        for(let j=0;j<arraytocheck[i].length;j++){

            var o1 = arrayOfSpecies[i][j];
            var no_collision = (
                o1.x > x+width ||
                o1.x + o1.width < x ||
                o1.y > y + height ||
                o1.y + o1.height < y
            );
            if(no_collision == false){
                return true;
            }

        }
    }
    return false;


}

    $(document).on("click","#start",function(){
        //console.log("start clicked");
        requestAnimationFrame(loop);
    });
});//end of document.ready function
</script>
<style >
    #canvas{
        background-color: lightblue;
    }
    .highscore{
        font-size: 1.5em;
        font-family: Press Start 2P;
    }
</style>
<body>

    <button type="button" name="button" id="start">Start</button><br>
    <div id="highscore"class="highscore">Score:</div>
    <canvas id="canvas" width="1400" height="800">
</body>
</html>
